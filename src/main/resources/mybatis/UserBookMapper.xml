<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.app.mapper.UserBookMapper">

	<!-- resultMap定義 (UserBook+Book JOIN) -->
	<resultMap id="UserBookResultMap" type="UserBook">
		<id property="id" column="ub_id" />
		<result property="userId" column="user_id" />
		<result property="bookId" column="book_id" />
		<result property="rating" column="rating" />
		<result property="status" column="status"
			typeHandler="com.example.app.typehandler.ReadingStatusTypeHandler" />
		<result property="memo" column="memo" />
		<result property="source" column="source" />
		<result property="createdAt" column="created_at" />
		<result property="updatedAt" column="updated_at" />
		<result property="isDeleted" column="is_deleted" />


		<!-- Bookオブジェクト埋め込み -->
		<association property="book" javaType="Book">
			<id property="id" column="b_id" />
			<result property="title" column="b_title" />
			<result property="author" column="b_author" />
			<result property="publisher" column="b_publisher" />
			<result property="publisherAt" column="b_publisher_at" />
			<result property="status" column="b_status" />
			<result property="manual" column="b_manual" />

			<association property="bookGenre" javaType="BookGenre">
				<id property="id" column="bg_id" />
				<result property="name" column="bg_name" />
			</association>

		</association>

	</resultMap>

	<!-- 1件取得(アクティブID(画面専用)/is_deleted=0) -->
	<select id="selectActiveById" resultMap="UserBookResultMap">
		SELECT
		ub.id AS ub_id,
		ub.user_id AS user_id,
		ub.book_id AS
		book_id,
		ub.rating AS rating,
		ub.status AS status,
		ub.memo AS memo,
		ub.created_at AS created_at,
		ub.updated_at AS updated_at,
		ub.is_deleted
		AS is_deleted,

		b.id AS b_id,
		b.title AS b_title,
		b.author AS
		b_author,
		b.publisher AS
		b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS
		b_genre,
		b.status AS b_status,
		b.manual AS b_manual,

		bg.id AS bg_id,
		bg.name AS bg_name

		FROM
		user_books ub
		LEFT JOIN
		books b ON ub.book_id =
		b.id
		LEFT JOIN
		book_genres bg ON b.genre = bg.id
		WHERE ub.id = #{id}
		AND
		ub.is_deleted
		= 0
	</select>
	
	<!-- 1件取得(管理用途/is_deleted無し) -->
	<select id="selectAnyById" resultMap="UserBookResultMap">
		SELECT
		ub.id AS ub_id,
		ub.user_id AS user_id,
		ub.book_id AS
		book_id,
		ub.rating AS rating,
		ub.status AS status,
		ub.memo AS memo,
		ub.created_at AS created_at,
		ub.updated_at AS updated_at,
		ub.is_deleted
		AS is_deleted,

		b.id AS b_id,
		b.title AS b_title,
		b.author AS
		b_author,
		b.publisher AS
		b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS
		b_genre,
		b.status AS b_status,
		b.manual AS b_manual,

		bg.id AS bg_id,
		bg.name AS bg_name

		FROM
		user_books ub
		LEFT JOIN
		books b ON ub.book_id =
		b.id
		LEFT JOIN
		book_genres bg ON b.genre = bg.id
		WHERE ub.id = #{id}
	</select>

	<!-- ユーザーの本棚一覧取得 -->
	<select id="selectActiveByUserId" parameterType="map"
		resultMap="UserBookResultMap">
		SELECT
		ub.id AS ub_id,
		ub.user_id AS user_id,
		ub.book_id AS
		book_id,
		ub.rating AS rating,
		ub.status AS status,
		ub.memo AS memo,
		ub.created_at AS created_at,
		ub.updated_at AS updated_at,
		ub.is_deleted
		AS is_deleted,

		b.id AS b_id,
		b.title AS b_title,
		b.author AS
		b_author,
		b.publisher AS
		b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS
		b_genre,
		b.status AS b_status,
		b.manual AS b_manual,

		bg.id AS bg_id,
		bg.name AS bg_name
		FROM
		user_books ub
		LEFT JOIN
		books b ON
		ub.book_id =
		b.id
		LEFT JOIN book_genres bg ON b.genre = bg.id
		WHERE
		ub.user_id =
		#{userId}
		AND
		ub.is_deleted = 0
		ORDER BY
		ub.created_at DESC
	</select>

	<!-- 新規登録 -->
	<insert id="insert" parameterType="UserBook"
		useGeneratedKeys="true" keyProperty="id">
		INSERT INTO user_books (
		user_id,
		book_id,
		rating,
		status,
		memo,
		source,
		is_deleted
		) VALUES (
		#{userId},
		#{bookId},
		#{rating},
		#{status,
		typeHandler=com.example.app.typehandler.ReadingStatusTypeHandler},
		#{memo},
		#{source},
		0
		)
	</insert>

	<!-- 重複追加回避 -->
	<select id="exists" resultType="int">
		SELECT COUNT(*)
		FROM user_books
		WHERE user_id = #{userId}
		AND book_id = #{bookId}
		AND is_deleted = 0
	</select>

	<!-- 論理削除含め存在チェック(使用非推奨) -->
	<select id="existsAll" resultType="int">
		SELECT COUNT(*)
		FROM user_books
		WHERE user_id = #{userId}
		AND book_id = #{bookId}
		AND is_deleted = 0
	</select>

	<!-- 更新 -->
	<update id="update" parameterType="UserBook">
		UPDATE user_books
		SET
		<if test="rating != null and rating &gt; 0">
			rating =
			#{rating},
		</if>
		status =#{status,
		typeHandler=com.example.app.typehandler.ReadingStatusTypeHandler},
		memo = #{memo},
		updated_at = CURRENT_TIMESTAMP
		WHERE id = #{id} AND
		is_deleted = 0
	</update>

	<!-- 論理削除 -->
	<update id="softDelete" parameterType="int">
		UPDATE user_books
		SET
		is_deleted = 1,
		updated_at = CURRENT_TIMESTAMP
		WHERE id = #{id}
	</update>

	<!-- 物理削除 -->
	<delete id="hardDelete" parameterType="int">
		DELETE
		FROM user_books
		WHERE id = #{id}
	</delete>

	<!-- 検索 + ソート + ページング -->
	<select id="search" resultMap="UserBookResultMap">
		SELECT
		ub.id AS ub_id,
		ub.user_id AS user_id,
		ub.book_id AS book_id,
		ub.rating AS rating,
		ub.status AS status,
		ub.memo AS memo,
		ub.created_at
		AS created_at,
		ub.updated_at AS updated_at,
		ub.is_deleted AS is_deleted,

		b.id AS b_id,
		b.title AS b_title,
		b.author AS b_author,
		b.publisher AS
		b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS
		b_genre,
		b.status AS b_status,
		b.manual AS b_manual,

		bg.id AS bg_id,
		bg.name AS
		bg_name

		FROM user_books ub
		LEFT JOIN books b ON ub.book_id = b.id
		LEFT
		JOIN
		book_genres bg ON b.genre = bg.id
		WHERE ub.user_id = #{userId}
		AND
		ub.is_deleted = 0
		AND b.manual = 1
		<if test="status != null">
			AND ub.status = #{status}
		</if>

		<if test="keyword != null and keyword != ''">
			AND (b.title LIKE CONCAT('%', #{keyword}, '%')
			OR b.author
			LIKE CONCAT('%', #{keyword}, '%'))
		</if>

		<!-- ソート -->
		<choose>
			<when test="sort == 'rating_desc'">
				ORDER BY ub.rating DESC
			</when>
			<when test="sort == 'rating_asc'">
				ORDER BY ub.rating ASC
			</when>
			<when test="sort == 'updated_desc'">
				ORDER BY ub.updated_at DESC
			</when>
			<otherwise>
				ORDER BY ub.created_at DESC
			</otherwise>
		</choose>

		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- 検索件数 -->
	<select id="countSearch" resultType="int">
		SELECT COUNT(*)
		FROM user_books ub
		LEFT JOIN books b ON ub.book_id =
		b.id
		WHERE ub.user_id = #{userId}
		AND ub.is_deleted = 0

		<if test="status != null">
			AND ub.status = #{status}
		</if>

		<if test="keyword != null and keyword != ''">
			AND (b.title LIKE CONCAT('%', #{keyword}, '%')
			OR b.author
			LIKE CONCAT('%', #{keyword}, '%'))
		</if>
	</select>


	<!-- 本棚に存在(is_deleted=0) -->
	<select id="selectActive" resultMap="UserBookResultMap">
		SELECT
		ub.id AS ub_id,
		ub.user_id AS user_id,
		ub.book_id AS book_id,
		ub.rating AS rating,
		ub.status AS status,
		ub.memo AS memo,
		ub.source AS source,
		ub.created_at AS created_at,
		ub.updated_at AS updated_at,
		ub.is_deleted AS is_deleted,
		b.id AS b_id,
		b.title AS b_title,
		b.author AS b_author,
		b.publisher AS b_publisher,
		b.publisher_at AS b_publisher_at,
		b.status AS b_status,
		b.manual AS b_manual,
		bg.id AS bg_id,
		bg.name AS bg_name
		FROM user_books ub
		LEFT JOIN books b ON ub.book_id = b.id
		LEFT JOIN book_genres bg ON b.genre = bg.id
		WHERE ub.user_id = #{userId}
		AND ub.book_id = #{bookId}
		AND ub.is_deleted = 0
		LIMIT 1
	</select>

	<!-- 論理削除済み(is_deleted=1) -->
	<select id="selectDeleted" resultType="UserBook">
		SELECT id, user_id,
		book_id, is_deleted
		FROM user_books
		WHERE user_id = #{userId}
		AND book_id
		= #{bookId}
		AND is_deleted = 1
	</select>

	<!-- 論理削除レコード復活(is_deleted1→0) -->
	<update id="restore">
		UPDATE user_books
		SET is_deleted = 0,
		updated_at =
		NOW()
		WHERE id = #{id}
	</update>

	<!-- 本棚に追加(API/管理者書籍) -->
	<select id="selectAddedBooksByUser" parameterType="int"
		resultMap="UserBookResultMap">
		SELECT
		ub.id AS ub_id,
		ub.user_id AS user_id,
		ub.book_id AS
		book_id,
		ub.rating AS rating,
		ub.status AS status,
		ub.memo AS memo,
		ub.created_at AS created_at,
		ub.updated_at AS updated_at,
		ub.is_deleted
		AS is_deleted,

		b.id AS b_id,
		b.title AS b_title,
		b.author AS
		b_author,
		b.publisher AS b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS
		b_genre,
		b.status AS b_status,
		b.manual AS b_manual,

		bg.id AS bg_id,
		bg.name AS bg_name
		FROM user_books ub
		LEFT JOIN books b ON
		ub.book_id =
		b.id
		LEFT JOIN book_genres bg ON b.genre = bg.id
		WHERE
		ub.user_id =
		#{userId}
		AND
		ub.is_deleted = 0
		AND b.manual = 1
		ORDER BY
		ub.created_at
		DESC
	</select>

	<!-- ユーザー作成書籍 -->
	<select id="selectManualBooksByUser" parameterType="int"
		resultMap="UserBookResultMap">
		SELECT
		ub.id AS ub_id,
		ub.user_id AS user_id,
		ub.book_id AS
		book_id,
		ub.rating AS rating,
		ub.status AS status,
		ub.memo AS memo,
		ub.created_at AS created_at,
		ub.updated_at AS updated_at,
		ub.is_deleted
		AS is_deleted,

		b.id AS b_id,
		b.title AS b_title,
		b.author AS
		b_author,
		b.publisher AS
		b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS
		b_genre,
		b.status AS b_status,
		b.manual AS b_manual,

		bg.id AS bg_id,
		bg.name AS bg_name
		FROM user_books ub
		LEFT JOIN books b ON
		ub.book_id =
		b.id
		LEFT JOIN book_genres bg ON b.genre = bg.id
		WHERE
		ub.user_id =
		#{userId}
		AND
		ub.is_deleted = 0
		AND b.manual = 0
		ORDER BY
		ub.created_at
		DESC
	</select>


</mapper>