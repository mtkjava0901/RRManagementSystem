<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.app.mapper.UserBookMapper">

	<!-- resultMap定義 (UserBook+Book JOIN) -->
	<resultMap id="UserBookResultMap" type="UserBook">
		<id property="id" column="id" />
		<result property="userId" column="user_id" />
		<result property="bookId" column="book_id" />
		<result property="rating" column="rating" />
		<result property="status" column="status"
			typeHandler="com.example.app.typehandler.ReadingStatusTypeHandler" />
		<result property="memo" column="memo" />
		<result property="createdAt" column="created_at" />
		<result property="updatedAt" column="updated_at" />
		<result property="isDeleted" column="is_deleted" />

		<!-- Bookオブジェクト埋め込み -->
		<association property="book" javaType="Book">
			<id property="id" column="b_id" />
			<result property="title" column="b_title" />
			<result property="author" column="b_author" />
			<result property="publisher" column="b_publisher" />
			<result property="publisherAt" column="b_publisher_at" />
			<result property="status" column="b_status" />
			<result property="manual" column="b_manual" />

			<!-- BookGenreオブジェクト埋め込み -->
			<association property="bookGenre" javaType="BookGenre">
				<id property="id" column="b_genre" />
				<result property="name" column="bg_name" />
			</association>

		</association>

	</resultMap>

	<!-- 1件取得 -->
	<select id="selectById" parameterType="int"
		resultMap="UserBookResultMap">
		SELECT
		ub.*,
		b.id AS b_id,
		b.title AS b_title,
		b.author AS
		b_author,
		b.publisher AS b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS b_genre,
		b.status AS b_status,
		b.manual AS b_manual
		FROM
		user_books ub
		LEFT JOIN books b ON ub.book_id = b.id
		WHERE ub.id = #{id}
		AND ub.is_deleted = 0
	</select>

	<!-- ユーザーの本棚一覧取得 -->
	<select id="selectByUserId" parameterType="int"
		resultMap="UserBookResultMap">
		SELECT
		ub.*,
		b.id AS b_id,
		b.title AS b_title,
		b.author AS
		b_author,
		b.publisher AS b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS b_genre,
		b.status AS b_status,
		b.manual AS b_manual
		FROM
		user_books ub
		LEFT JOIN books b ON ub.book_id = b.id
		WHERE ub.user_id =
		#{userId}
		AND ub.is_deleted = 0
		ORDER BY
		ub.created_at DESC
	</select>

	<!-- 新規登録 -->
	<insert id="insert" parameterType="UserBook"
		useGeneratedKeys="true" keyProperty="id">
		INSERT INTO user_books (
		user_id,
		book_id,
		rating,
		status,
		memo,
		is_deleted
		) VALUES (
		#{userId},
		#{bookId},
		#{rating},
		#{status,
		typeHandler=com.example.app.typehandler.ReadingStatusTypeHandler},
		#{memo},
		0
		)
	</insert>

	<!-- 倫理削除含め存在チェック -->
	<select id="existsAll" resultType="int">
		SELECT COUNT(*)
		FROM user_books
		WHERE user_id = #{userId}
		AND book_id = #{bookId}
	</select>

	<!-- 倫理削除レコード復活(is_deleted1→0) -->
	<update id="restore">
		UPDATE user_books
		SET is_deleted = 0,
		updated_at = CURRENT_TIMESTAMP
		WHERE user_id = #{userId}
		AND book_id = #{bookId}
	</update>

	<!-- 更新 -->
	<update id="update" parameterType="UserBook">
		UPDATE user_books
		SET
		rating =
		#{rating},
		status =#{status,
		typeHandler=com.example.app.typehandler.ReadingStatusTypeHandler},
		memo = #{memo},
		updated_at = CURRENT_TIMESTAMP
		WHERE id = #{id} AND
		is_deleted = 0
	</update>

	<!-- 論理削除 -->
	<update id="softDelete" parameterType="int">
		UPDATE user_books
		SET
		is_deleted = 1,
		updated_at = CURRENT_TIMESTAMP
		WHERE id = #{id}
	</update>

	<!-- 物理削除 -->
	<delete id="hardDelete" parameterType="int">
		DELETE
		FROM user_books
		WHERE id = #{id}
	</delete>

	<!-- 検索 + ソート + ページング -->
	<select id="search" resultMap="UserBookResultMap">
		SELECT
		ub.*,
		b.id AS b_id,
		b.title AS b_title,
		b.author AS b_author,
		b.publisher AS b_publisher,
		b.publisher_at AS b_publisher_at,
		b.genre AS
		b_genre,
		b.status AS b_status,
		b.manual AS b_manual
		FROM user_books ub
		LEFT JOIN books b ON ub.book_id = b.id
		WHERE ub.user_id = #{userId}
		AND
		ub.is_deleted = 0

		<if test="status != null">
			AND ub.status = #{status}
		</if>

		<if test="keyword != null and keyword != ''">
			AND (b.title LIKE CONCAT('%', #{keyword}, '%')
			OR b.author
			LIKE CONCAT('%', #{keyword}, '%'))
		</if>

		<!-- ソート -->
		<choose>
			<when test="sort == 'rating_desc'">
				ORDER BY ub.rating DESC
			</when>
			<when test="sort == 'rating_asc'">
				ORDER BY ub.rating ASC
			</when>
			<when test="sort == 'updated_desc'">
				ORDER BY ub.updated_at DESC
			</when>
			<otherwise>
				ORDER BY ub.created_at DESC
			</otherwise>
		</choose>

		LIMIT #{limit} OFFSET #{offset}
	</select>

	<!-- 検索件数 -->
	<select id="countSearch" resultType="int">
		SELECT COUNT(*)
		FROM user_books ub
		LEFT JOIN books b ON ub.book_id =
		b.id
		WHERE ub.user_id = #{userId}
		AND ub.is_deleted = 0

		<if test="status != null">
			AND ub.status = #{status}
		</if>

		<if test="keyword != null and keyword != ''">
			AND (b.title LIKE CONCAT('%', #{keyword}, '%')
			OR b.author
			LIKE CONCAT('%', #{keyword}, '%'))
		</if>
	</select>

	<!-- 重複追加回避 -->
	<select id="exists" resultType="int">
		SELECT COUNT(*)
		FROM user_books
		WHERE user_id = #{userId}
		AND book_id = #{bookId}
		AND is_deleted = 0
	</select>

</mapper>