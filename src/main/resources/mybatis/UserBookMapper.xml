<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.app.mapper.UserBookMapper">

	<!-- resultMap定義 -->
	<resultMap id="UserBookResultMap" type="UserBook">
		<id property="id" column="id" />
		<result property="userId" column="user_id" />
		<result property="bookId" column="book_id" />
		<result property="rating" column="rating" />
		<result property="status" column="status"
			javaType="com.example.app.enums.ReadingStatus"
			typeHandler="com.example.app.typehandler.ReadingStatusTypeHandler" />
		<result property="memo" column="memo" />
		<result property="createdAt" column="created_at" />
		<result property="updatedAt" column="updated_at" />
		<result property="isDeleted" column="is_deleted" />
	</resultMap>

	<!-- 1件取得 -->
	<select id="selectById" resultMap="UserBookResultMap">
		SELECT * FROM user_books WHERE
		id = #{id} AND is_deleted = 0
	</select>

	<!-- ユーザーの本棚一覧取得 -->
	<select id="selectByUserId" resultMap="UserBookResultMap">
		SELECT * FROM user_books
		WHERE user_id = #{userId} AND is_deleted = 0
	</select>

	<!-- 新規登録 -->
	<insert id="insert" useGeneratedKeys="true" keyProperty="id">
		INSERT
		INTO user_books (user_id, book_id, rating, status, memo)
		VALUES
		(#{userId}, #{bookId}, #{rating},
		#{status,
		typeHandler=com.example.app.typehandler.ReadingStatusTypeHandler},
		#{memo})
	</insert>

	<!-- 更新 -->
	<update id="update">
		UPDATE user_books
		SET rating = #{rating},
		status =
		#{status,
		typeHandler=com.example.app.typehandler.ReadingStatusTypeHandler},
		memo = #{memo},
		updated_at = CURRENT_TIMESTAMP
		WHERE id = #{id} AND
		is_deleted = 0
	</update>

	<!-- 論理削除 -->
	<update id="delete">
		UPDATE user_books
		SET is_deleted = 1, updated_at =
		CURRENT_TIMESTAMP
		WHERE id = #{id}
	</update>

</mapper>